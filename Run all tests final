"""
–ì–û–õ–û–í–ù–ò–ô –§–ê–ô–õ –¢–ï–°–¢–£–í–ê–ù–ù–Ø
–ó–∞–ø—É—Å–∫ –≤—Å—ñ—Ö —Ç—Ä—å–æ—Ö –º–æ–¥—É–ª—ñ–≤ –∑ –æ–¥—Ä–∞–∑—É –≤–∏–≤–æ–¥–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –¢–ê –¥—ñ–∞–≥—Ä–∞–º
"""

import sys
import numpy as np
import pandas as pd
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import seaborn as sns

# –Ü–º–ø–æ—Ä—Ç –ø–æ–∫—Ä–∞—â–µ–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤
from test_forecast_enhanced import DemandForecast
from test_recommendations_enhanced import RecommendationSystem
from test_segmentation_enhanced import CustomerSegmentation


class TradeManagementSystem:
    """–Ü–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è"""
    
    def __init__(self):
        self.forecast_model = None
        self.recommendation_model = None
        self.segmentation_model = None
        
    def generate_test_data(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–µ—Å—Ç–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö"""
        print("="*80)
        print("–ì–ï–ù–ï–†–ê–¶–Ü–Ø –¢–ï–°–¢–û–í–ò–• –î–ê–ù–ò–•")
        print("="*80)
        
        np.random.seed(42)
        
        # 1. –î–∞–Ω—ñ –ø—Ä–æ–¥–∞–∂—ñ–≤
        print("\n1. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –ø—Ä–æ–¥–∞–∂—ñ–≤...")
        dates = pd.date_range(start='2023-01-01', end='2024-12-31', freq='D')
        trend = np.linspace(50, 150, len(dates))
        seasonality = 30 * np.sin(2 * np.pi * np.arange(len(dates)) / 365)
        noise = np.random.normal(0, 10, len(dates))
        quantities = trend + seasonality + noise
        quantities = np.maximum(quantities, 0)
        
        sales_data = pd.DataFrame({
            'date': dates,
            'quantity': quantities
        })
        print(f"   –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ: {len(sales_data)} –¥–Ω—ñ–≤")
        
        # 2. –î–∞–Ω—ñ –≤–∑–∞—î–º–æ–¥—ñ–π
        print("\n2. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –≤–∑–∞—î–º–æ–¥—ñ–π...")
        interactions = []
        for _ in range(800):
            user_id = np.random.randint(1, 101)
            item_id = np.random.randint(1, 51)
            quantity = np.random.randint(1, 10)
            interactions.append({
                'user_id': user_id,
                'item_id': item_id,
                'quantity': quantity
            })
        
        interactions_df = pd.DataFrame(interactions)
        interactions_df = interactions_df.groupby(['user_id', 'item_id'])['quantity'].sum().reset_index()
        print(f"   –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ: {len(interactions_df)} –≤–∑–∞—î–º–æ–¥—ñ–π")
        
        # 3. –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
        print("\n3. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö...")
        start_date = datetime(2023, 1, 1)
        transactions = []
        for _ in range(1200):
            customer_id = np.random.randint(1, 201)
            days_offset = np.random.randint(0, 365)
            date = start_date + timedelta(days=days_offset)
            amount = np.random.uniform(50, 500)
            transactions.append({
                'customer_id': customer_id,
                'date': date,
                'amount': amount
            })
        
        transactions_df = pd.DataFrame(transactions)
        print(f"   –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ: {len(transactions_df)} —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π")
        
        return sales_data, interactions_df, transactions_df
    
    def test_all_modules(self):
        """–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –º–æ–¥—É–ª—ñ–≤"""
        
        # –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö
        sales_data, interactions_df, transactions_df = self.generate_test_data()
        
        # ========================================================================
        # –ú–û–î–£–õ–¨ 1: –ü–†–û–ì–ù–û–ó–£–í–ê–ù–ù–Ø –ü–û–ü–ò–¢–£
        # ========================================================================
        print("\n\n")
        print("="*80)
        print("–ú–û–î–£–õ–¨ 1: –ü–†–û–ì–ù–û–ó–£–í–ê–ù–ù–Ø –ü–û–ü–ò–¢–£ (LSTM)")
        print("="*80)
        
        self.forecast_model = DemandForecast(sequence_length=30)
        self.forecast_model.train(sales_data)
        forecast_metrics = self.forecast_model.evaluate()
        forecast = self.forecast_model.forecast(sales_data, days_ahead=30)
        
        # –†–ï–ó–£–õ–¨–¢–ê–¢–ò –ú–û–î–£–õ–Ø 1
        print("\n" + "="*80)
        print("–†–ï–ó–£–õ–¨–¢–ê–¢–ò –ü–†–û–ì–ù–û–ó–£–í–ê–ù–ù–Ø")
        print("="*80)
        print(f"\n–ú–µ—Ç—Ä–∏–∫–∏ —è–∫–æ—Å—Ç—ñ:")
        print(f"  RMSE: {forecast_metrics['rmse']:.2f} (–º–µ—Ç–∞: <20) - {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if forecast_metrics['rmse'] < 20 else '‚úó'}")
        print(f"  MAE: {forecast_metrics['mae']:.2f} (–º–µ—Ç–∞: <15) - {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if forecast_metrics['mae'] < 15 else '‚úó'}")
        print(f"  MAPE: {forecast_metrics['mape']:.2f}% (–º–µ—Ç–∞: <15%) - {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if forecast_metrics['mape'] < 15 else '‚úó'}")
        
        print(f"\n–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ 30 –¥–Ω—ñ–≤:")
        print(f"  –°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è: {forecast['predicted_quantity'].mean():.2f} –æ–¥/–¥–µ–Ω—å")
        print(f"  –ó–∞–≥–∞–ª—å–Ω–∏–π –æ–±—Å—è–≥: {forecast['predicted_quantity'].sum():.0f} –æ–¥–∏–Ω–∏—Ü—å")
        
        print("\n–ü–µ—Ä—à—ñ 5 –¥–Ω—ñ–≤ –ø—Ä–æ–≥–Ω–æ–∑—É:")
        print(forecast.head(5).to_string(index=False))
        
        # –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ú–û–î–£–õ–Ø 1
        print("\n" + "="*80)
        print("–í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ú–û–î–£–õ–Ø 1")
        print("="*80)
        self.forecast_model.plot_training_history()
        self.forecast_model.plot_predictions()
        self.forecast_model.plot_forecast()
        self.forecast_model.plot_metrics_dashboard(forecast_metrics)
        
        # ========================================================================
        # –ú–û–î–£–õ–¨ 2: –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–ô–ù–ê –°–ò–°–¢–ï–ú–ê
        # ========================================================================
        print("\n\n")
        print("="*80)
        print("–ú–û–î–£–õ–¨ 2: –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–ô–ù–ê –°–ò–°–¢–ï–ú–ê")
        print("="*80)
        
        self.recommendation_model = RecommendationSystem()
        self.recommendation_model.train(interactions_df)
        rec_metrics = self.recommendation_model.evaluate(interactions_df)
        
        # –†–ï–ó–£–õ–¨–¢–ê–¢–ò –ú–û–î–£–õ–Ø 2
        print("\n" + "="*80)
        print("–†–ï–ó–£–õ–¨–¢–ê–¢–ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–ô")
        print("="*80)
        print(f"\n–ú–µ—Ç—Ä–∏–∫–∏ —è–∫–æ—Å—Ç—ñ:")
        print(f"  Precision@10: {rec_metrics['precision@10']:.2%} (–º–µ—Ç–∞: >70%) - {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if rec_metrics['precision@10'] > 0.70 else '‚úó'}")
        print(f"  Recall@10: {rec_metrics['recall@10']:.2%} (–º–µ—Ç–∞: >65%) - {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if rec_metrics['recall@10'] > 0.65 else '‚úó'}")
        print(f"  NDCG@10: {rec_metrics['ndcg@10']:.4f} (–º–µ—Ç–∞: >0.70) - {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if rec_metrics['ndcg@10'] > 0.70 else '‚úó'}")
        
        # –ü—Ä–∏–∫–ª–∞–¥–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π
        print("\n–ü—Ä–∏–∫–ª–∞–¥–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:")
        test_users = [5, 15, 25, 35]
        for user_id in test_users[:2]:  # –ü–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ 2 –ø—Ä–∏–∫–ª–∞–¥–∏
            recommendations = self.recommendation_model.recommend(user_id, top_n=5)
            print(f"\n–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á #{user_id} - –¢–æ–ø-5 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π:")
            for i, (item_id, score) in enumerate(recommendations, 1):
                print(f"  {i}. –¢–æ–≤–∞—Ä #{item_id:03d} - Score: {score:.4f}")
        
        # –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ú–û–î–£–õ–Ø 2
        print("\n" + "="*80)
        print("–í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ú–û–î–£–õ–Ø 2")
        print("="*80)
        self.recommendation_model.plot_user_item_heatmap()
        self.recommendation_model.plot_popularity_distribution()
        self.recommendation_model.plot_user_activity()
        self.recommendation_model.plot_recommendation_examples()
        self.recommendation_model.plot_metrics_dashboard(rec_metrics)
        
        # ========================================================================
        # –ú–û–î–£–õ–¨ 3: –°–ï–ì–ú–ï–ù–¢–ê–¶–Ü–Ø –ö–õ–Ü–Ñ–ù–¢–Ü–í
        # ========================================================================
        print("\n\n")
        print("="*80)
        print("–ú–û–î–£–õ–¨ 3: –°–ï–ì–ú–ï–ù–¢–ê–¶–Ü–Ø –ö–õ–Ü–Ñ–ù–¢–Ü–í (K-MEANS + RFM)")
        print("="*80)
        
        # –°–ø–æ—á–∞—Ç–∫—É –∑–Ω–∞—Ö–æ–¥–∏–º–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–µ K —ñ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –º–µ—Ç—Ä–∏–∫–∏
        temp_segmentation = CustomerSegmentation(n_clusters=4)
        rfm_temp = temp_segmentation.calculate_rfm(transactions_df)
        optimal_k = temp_segmentation.find_optimal_k(rfm_temp, max_k=6)
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω—É –º–æ–¥–µ–ª—å –∑ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–º K —ñ –∫–æ–ø—ñ—é—î–º–æ –º–µ—Ç—Ä–∏–∫–∏
        self.segmentation_model = CustomerSegmentation(n_clusters=optimal_k)
        self.segmentation_model.inertias = temp_segmentation.inertias
        self.segmentation_model.silhouette_scores = temp_segmentation.silhouette_scores
        self.segmentation_model.fit(transactions_df)
        
        # –†–ï–ó–£–õ–¨–¢–ê–¢–ò –ú–û–î–£–õ–Ø 3
        print("\n" + "="*80)
        print("–†–ï–ó–£–õ–¨–¢–ê–¢–ò –°–ï–ì–ú–ï–ù–¢–ê–¶–Ü–á")
        print("="*80)
        
        summary = self.segmentation_model.get_summary()
        print("\n–¢–∞–±–ª–∏—Ü—è —Å–µ–≥–º–µ–Ω—Ç—ñ–≤:")
        print(summary.to_string(index=False))
        
        print(f"\n–Ø–∫—ñ—Å—Ç—å —Å–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—ó:")
        print(f"  Silhouette Score: {self.segmentation_model.sil_score:.3f} - {'‚úì –í–∏—Å–æ–∫–∞ —è–∫—ñ—Å—Ç—å' if self.segmentation_model.sil_score > 0.3 else '‚úó –ù–∏–∑—å–∫–∞ —è–∫—ñ—Å—Ç—å'}")
        print(f"  –û–ø—Ç–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤: {optimal_k}")
        
        # –ü—Ä–∏–∫–ª–∞–¥ –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
        print("\n–ü—Ä–∏–∫–ª–∞–¥: –ö–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞")
        new_customer = pd.DataFrame({
            'recency': [15],
            'frequency': [10],
            'monetary': [2500]
        })
        cluster_id = self.segmentation_model.predict(new_customer)
        cluster_name = self.segmentation_model.cluster_descriptions[cluster_id]['name']
        print(f"  –ö–ª—ñ—î–Ω—Ç (R=15, F=10, M=2500) ‚Üí –°–µ–≥–º–µ–Ω—Ç: {cluster_name}")
        
        # –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ú–û–î–£–õ–Ø 3
        print("\n" + "="*80)
        print("–í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á –ú–û–î–£–õ–Ø 3")
        print("="*80)
        self.segmentation_model.plot_elbow_method()
        self.segmentation_model.plot_3d_clusters()
        self.segmentation_model.plot_cluster_profiles()
        self.segmentation_model.plot_rfm_distributions()
        self.segmentation_model.plot_cluster_comparison()
        
        # ========================================================================
        # –ü–Ü–î–°–£–ú–ö–û–í–ò–ô –î–ê–®–ë–û–†–î
        # ========================================================================
        print("\n\n")
        print("="*80)
        print("–°–¢–í–û–†–ï–ù–ù–Ø –ü–Ü–î–°–£–ú–ö–û–í–û–ì–û –î–ê–®–ë–û–†–î–£")
        print("="*80)
        self.create_final_dashboard(forecast_metrics, rec_metrics)
        
        # ========================================================================
        # –§–Ü–ù–ê–õ–¨–ù–Ü –†–ï–ó–£–õ–¨–¢–ê–¢–ò
        # ========================================================================
        self.print_final_summary(forecast_metrics, rec_metrics, forecast)
        
    def create_final_dashboard(self, forecast_metrics, rec_metrics):
        """–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫–æ–≤–æ–≥–æ –¥–∞—à–±–æ—Ä–¥—É"""
        
        fig = plt.figure(figsize=(18, 12))
        gs = fig.add_gridspec(3, 3, hspace=0.4, wspace=0.3)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        fig.suptitle('WEB-–°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –¢–û–†–ì–û–í–ï–õ–¨–ù–ò–ú –ü–Ü–î–ü–†–ò–Ñ–ú–°–¢–í–û–ú –ó –®–Ü\n–ü—ñ–¥—Å—É–º–∫–æ–≤–∏–π –¥–∞—à–±–æ—Ä–¥', 
                    fontsize=16, fontweight='bold', y=0.98)
        
        # 1. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è
        ax1 = fig.add_subplot(gs[0, 0])
        metrics_forecast = ['RMSE', 'MAE', 'MAPE']
        values_forecast = [forecast_metrics['rmse'], forecast_metrics['mae'], forecast_metrics['mape']]
        colors1 = ['#3498db', '#2ecc71', '#f39c12']
        
        bars1 = ax1.bar(metrics_forecast, values_forecast, color=colors1, alpha=0.7, edgecolor='black')
        ax1.set_title('–ú–æ–¥—É–ª—å 1: –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è', fontweight='bold')
        ax1.set_ylabel('–ó–Ω–∞—á–µ–Ω–Ω—è')
        ax1.grid(True, alpha=0.3, axis='y')
        
        for bar, value in zip(bars1, values_forecast):
            height = bar.get_height()
            ax1.text(bar.get_x() + bar.get_width()/2., height,
                    f'{value:.2f}', ha='center', va='bottom', fontweight='bold')
        
        # 2. –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π
        ax2 = fig.add_subplot(gs[0, 1])
        metrics_rec = ['Precision', 'Recall', 'NDCG']
        values_rec = [rec_metrics['precision@10'], rec_metrics['recall@10'], rec_metrics['ndcg@10']]
        colors2 = ['#e74c3c', '#9b59b6', '#1abc9c']
        
        bars2 = ax2.bar(metrics_rec, values_rec, color=colors2, alpha=0.7, edgecolor='black')
        ax2.set_title('–ú–æ–¥—É–ª—å 2: –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π', fontweight='bold')
        ax2.set_ylabel('–ó–Ω–∞—á–µ–Ω–Ω—è')
        ax2.set_ylim(0, 1)
        ax2.grid(True, alpha=0.3, axis='y')
        
        for bar, value in zip(bars2, values_rec):
            height = bar.get_height()
            ax2.text(bar.get_x() + bar.get_width()/2., height,
                    f'{value:.2%}' if value < 1 else f'{value:.3f}', 
                    ha='center', va='bottom', fontweight='bold')
        
        # 3. –°–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç—ñ–≤
        ax3 = fig.add_subplot(gs[0, 2])
        segment_names = [info['name'] for info in self.segmentation_model.cluster_descriptions.values()]
        segment_sizes = [info['size'] for info in self.segmentation_model.cluster_descriptions.values()]
        colors3 = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12']
        
        wedges, texts, autotexts = ax3.pie(segment_sizes, labels=segment_names, autopct='%1.1f%%',
                                           colors=colors3[:len(segment_sizes)], startangle=90)
        for autotext in autotexts:
            autotext.set_color('white')
            autotext.set_fontweight('bold')
            autotext.set_fontsize(9)
        ax3.set_title('–ú–æ–¥—É–ª—å 3: –†–æ–∑–ø–æ–¥—ñ–ª —Å–µ–≥–º–µ–Ω—Ç—ñ–≤', fontweight='bold')
        
        # 4. –°—Ç–∞—Ç—É—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–∏–º–æ–≥
        ax4 = fig.add_subplot(gs[1, :])
        
        requirements = [
            'RMSE < 20',
            'MAE < 15',
            'MAPE < 15%',
            'Precision > 70%',
            'Recall > 65%',
            'NDCG > 0.70',
            '–û–ø—Ç–∏–º–∞–ª—å–Ω–µ K',
            'Silhouette > 0.3'
        ]
        
        statuses = [
            forecast_metrics['rmse'] < 20,
            forecast_metrics['mae'] < 15,
            forecast_metrics['mape'] < 15,
            rec_metrics['precision@10'] > 0.70,
            rec_metrics['recall@10'] > 0.65,
            rec_metrics['ndcg@10'] > 0.70,
            True,
            self.segmentation_model.sil_score > 0.3
        ]
        
        colors_status = ['#2ecc71' if s else '#e74c3c' for s in statuses]
        
        y_pos = np.arange(len(requirements))
        bars = ax4.barh(y_pos, [1]*len(requirements), color=colors_status, alpha=0.7, edgecolor='black')
        ax4.set_yticks(y_pos)
        ax4.set_yticklabels(requirements)
        ax4.set_xlim(0, 1.2)
        ax4.set_title('–í–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–∏–º–æ–≥ —è–∫–æ—Å—Ç—ñ', fontsize=14, fontweight='bold')
        ax4.set_xticks([])
        
        for i, (bar, status) in enumerate(zip(bars, statuses)):
            status_text = '‚úì –ü–†–û–ô–î–ï–ù–û' if status else '‚úó –ù–ï –ü–†–û–ô–î–ï–ù–û'
            ax4.text(0.5, bar.get_y() + bar.get_height()/2., status_text,
                    ha='center', va='center', fontweight='bold', color='white', fontsize=10)
        
        # 5. –û—á—ñ–∫—É–≤–∞–Ω—ñ –±—ñ–∑–Ω–µ—Å-–µ—Ñ–µ–∫—Ç–∏
        ax5 = fig.add_subplot(gs[2, :2])
        
        effects = [
            '–ó–±—ñ–ª—å—à–µ–Ω–Ω—è\n—Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —á–µ–∫—É',
            '–ó–Ω–∏–∂–µ–Ω–Ω—è\n—Å–∫–ª–∞–¥—Å—å–∫–∏—Ö –≤–∏—Ç—Ä–∞—Ç',
            '–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è\n–ª–æ—è–ª—å–Ω–æ—Å—Ç—ñ',
            'ROI –∑–∞ —Ä—ñ–∫'
        ]
        
        values_effects = [22.5, 25, 35, 175]
        colors_effects = ['#3498db', '#2ecc71', '#f39c12', '#e74c3c']
        
        bars = ax5.bar(effects, values_effects, color=colors_effects, alpha=0.7, edgecolor='black')
        ax5.set_ylabel('–í—ñ–¥—Å–æ—Ç–æ–∫ (%)')
        ax5.set_title('–û—á—ñ–∫—É–≤–∞–Ω—ñ –±—ñ–∑–Ω–µ—Å-–µ—Ñ–µ–∫—Ç–∏', fontsize=14, fontweight='bold')
        ax5.grid(True, alpha=0.3, axis='y')
        
        for bar, value in zip(bars, values_effects):
            height = bar.get_height()
            ax5.text(bar.get_x() + bar.get_width()/2., height,
                    f'+{value:.1f}%', ha='center', va='bottom', fontweight='bold', fontsize=11)
        
        # 6. –ó–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å
        ax6 = fig.add_subplot(gs[2, 2])
        ax6.axis('off')
        
        all_passed = all(statuses)
        status_color = '#2ecc71' if all_passed else '#e74c3c'
        status_text = '–ì–û–¢–û–í–û –î–û\n–í–ü–†–û–í–ê–î–ñ–ï–ù–ù–Ø' if all_passed else '–ü–û–¢–†–ï–ë–£–Ñ\n–î–û–û–ü–†–ê–¶–Æ–í–ê–ù–ù–Ø'
        
        circle = plt.Circle((0.5, 0.5), 0.4, color=status_color, alpha=0.3)
        ax6.add_patch(circle)
        ax6.text(0.5, 0.5, status_text, ha='center', va='center', 
                fontsize=14, fontweight='bold', color=status_color)
        ax6.set_xlim(0, 1)
        ax6.set_ylim(0, 1)
        
        plt.savefig('/mnt/user-data/outputs/00_final_dashboard.png', dpi=300, bbox_inches='tight')
        print("  ‚úì –ó–±–µ—Ä–µ–∂–µ–Ω–æ: 00_final_dashboard.png")
        plt.close()
        
    def print_final_summary(self, forecast_metrics, rec_metrics, forecast):
        """–í–∏–≤–µ–¥–µ–Ω–Ω—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—é–º–µ"""
        print("\n\n")
        print("="*80)
        print("–§–Ü–ù–ê–õ–¨–ù–ï –†–ï–ó–Æ–ú–ï –°–ò–°–¢–ï–ú–ò")
        print("="*80)
        
        print("\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
        print("‚îÇ –ú–û–î–£–õ–¨ 1: –ü–†–û–ì–ù–û–ó–£–í–ê–ù–ù–Ø –ü–û–ü–ò–¢–£                                      ‚îÇ")
        print("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§")
        print(f"‚îÇ RMSE: {forecast_metrics['rmse']:6.2f} (–º–µ—Ç–∞: <20)      {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if forecast_metrics['rmse'] < 20 else '‚úó –ù–ï –î–û–°–Ø–ì–ù–£–¢–û':>20} ‚îÇ")
        print(f"‚îÇ MAE:  {forecast_metrics['mae']:6.2f} (–º–µ—Ç–∞: <15)      {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if forecast_metrics['mae'] < 15 else '‚úó –ù–ï –î–û–°–Ø–ì–ù–£–¢–û':>20} ‚îÇ")
        print(f"‚îÇ MAPE: {forecast_metrics['mape']:6.2f}% (–º–µ—Ç–∞: <15%)    {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if forecast_metrics['mape'] < 15 else '‚úó –ù–ï –î–û–°–Ø–ì–ù–£–¢–û':>20} ‚îÇ")
        print(f"‚îÇ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º—ñ—Å—è—Ü—å: {forecast['predicted_quantity'].sum():>5.0f} –æ–¥–∏–Ω–∏—Ü—å                           ‚îÇ")
        print("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
        
        print("\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
        print("‚îÇ –ú–û–î–£–õ–¨ 2: –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–ô–ù–ê –°–ò–°–¢–ï–ú–ê                                    ‚îÇ")
        print("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§")
        print(f"‚îÇ Precision@10: {rec_metrics['precision@10']:5.1%} (–º–µ—Ç–∞: >70%)  {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if rec_metrics['precision@10'] > 0.70 else '‚úó –ù–ï –î–û–°–Ø–ì–ù–£–¢–û':>20} ‚îÇ")
        print(f"‚îÇ Recall@10:    {rec_metrics['recall@10']:5.1%} (–º–µ—Ç–∞: >65%)  {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if rec_metrics['recall@10'] > 0.65 else '‚úó –ù–ï –î–û–°–Ø–ì–ù–£–¢–û':>20} ‚îÇ")
        print(f"‚îÇ NDCG@10:    {rec_metrics['ndcg@10']:6.4f} (–º–µ—Ç–∞: >0.70) {'‚úì –î–û–°–Ø–ì–ù–£–¢–û' if rec_metrics['ndcg@10'] > 0.70 else '‚úó –ù–ï –î–û–°–Ø–ì–ù–£–¢–û':>20} ‚îÇ")
        print("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
        
        print("\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê")
        print("‚îÇ –ú–û–î–£–õ–¨ 3: –°–ï–ì–ú–ï–ù–¢–ê–¶–Ü–Ø –ö–õ–Ü–Ñ–ù–¢–Ü–í                                      ‚îÇ")
        print("‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§")
        print(f"‚îÇ –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ñ–≤: {self.segmentation_model.n_clusters:>2}                                       ‚îÇ")
        print(f"‚îÇ Silhouette Score: {self.segmentation_model.sil_score:5.3f}   {'‚úì –í–∏—Å–æ–∫–∞ —è–∫—ñ—Å—Ç—å' if self.segmentation_model.sil_score > 0.3 else '‚úó –ù–∏–∑—å–∫–∞ —è–∫—ñ—Å—Ç—å':>20} ‚îÇ")
        print(f"‚îÇ –Ü–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–æ–≤–∞–Ω—ñ —Å–µ–≥–º–µ–Ω—Ç–∏:                     {'‚úì –¢–∞–∫':>20} ‚îÇ")
        print("‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò")
        
        print("\n" + "="*80)
        print("–í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–á")
        print("="*80)
        print("\n–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ 15 –¥—ñ–∞–≥—Ä–∞–º:")
        print("  üìä 00_final_dashboard.png - –ü—ñ–¥—Å—É–º–∫–æ–≤–∏–π –¥–∞—à–±–æ—Ä–¥")
        print("\n  –ú–æ–¥—É–ª—å 1 (–ü—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è):")
        print("    üìà 01_training_history.png")
        print("    üìà 02_predictions_comparison.png")
        print("    üìà 03_forecast.png")
        print("    üìà 04_metrics_dashboard.png")
        print("\n  –ú–æ–¥—É–ª—å 2 (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó):")
        print("    üìä 05_user_item_heatmap.png")
        print("    üìä 06_popularity_distribution.png")
        print("    üìä 07_user_activity.png")
        print("    üìä 08_recommendation_examples.png")
        print("    üìä 09_recommendation_dashboard.png")
        print("\n  –ú–æ–¥—É–ª—å 3 (–°–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—è):")
        print("    üìâ 10_elbow_method.png")
        print("    üìâ 11_3d_clusters.png")
        print("    üìâ 12_cluster_profiles.png")
        print("    üìâ 13_rfm_distributions.png")
        print("    üìâ 14_cluster_comparison.png")
        
        print("\n" + "="*80)
        print("–û–ß–Ü–ö–£–í–ê–ù–ò–ô –ë–Ü–ó–ù–ï–°-–ï–§–ï–ö–¢")
        print("="*80)
        print("\n  üí∞ –ó–±—ñ–ª—å—à–µ–Ω–Ω—è —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —á–µ–∫—É:    +20-25%")
        print("  üì¶ –ó–Ω–∏–∂–µ–Ω–Ω—è —Å–∫–ª–∞–¥—Å—å–∫–∏—Ö –≤–∏—Ç—Ä–∞—Ç:    -20-30%")
        print("  ‚ù§Ô∏è  –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ª–æ—è–ª—å–Ω–æ—Å—Ç—ñ:        +30-40%")
        print("  üìà ROI –∑–∞ –ø–µ—Ä—à–∏–π —Ä—ñ–∫:             150-200%")
        
        print("\n" + "="*80)
        print("–°–¢–ê–¢–£–°: ‚úÖ –ì–û–¢–û–í–û –î–û –í–ü–†–û–í–ê–î–ñ–ï–ù–ù–Ø")
        print("="*80)


def main():
    """–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è"""
    print("\n")
    print("*"*80)
    print("*" + " "*78 + "*")
    print("*" + " "*15 + "WEB-–°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –¢–û–†–ì–û–í–ï–õ–¨–ù–ò–ú –ü–Ü–î–ü–†–ò–Ñ–ú–°–¢–í–û–ú" + " "*13 + "*")
    print("*" + " "*25 + "–ó –®–¢–£–ß–ù–ò–ú –Ü–ù–¢–ï–õ–ï–ö–¢–û–ú" + " "*34 + "*")
    print("*" + " "*78 + "*")
    print("*"*80)
    print()
    
    try:
        system = TradeManagementSystem()
        system.test_all_modules()
        
        print("\n\n")
        print("="*80)
        print("‚úÖ –¢–ï–°–¢–£–í–ê–ù–ù–Ø –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–Ü–®–ù–û")
        print("="*80)
        print()
        
    except Exception as e:
        print(f"\n\n‚ùå –ü–û–ú–ò–õ–ö–ê: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
